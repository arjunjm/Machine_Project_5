cscope 15 $HOME/Downloads/MP5               0000051308
	@Scheduler.C

1 
	~"utûs.H
"

2 
	~"ScheduÀr.H
"

3 
	~"c⁄sﬁe.H
"

4 
	~"as£π.H
"

5 
	~"sim∂e_disk.H
"

6 
	~"blockög_disk.H
"

8 
BlockögDisk
 * 
SYSTEM_DISK
;

10 
	gScheduÀr
::
	$ScheduÀr
()

12 
‰⁄t_ödex
 = 0;

13 
√xt_ödex
 = 0;

14 
i
=0; i< 
MAX_QUEUE_SIZE
; i++)

15 
ªady_Queue
[
i
] = 
NULL
;

16 
	}
}

18 
	gScheduÀr
::
	$yõld
()

20 
ãmpcou¡
 = 0;

21 if((
‰⁄t_ödex
 =
√xt_ödex
Ë&& (
ªady_Queue
[‰⁄t_ödex] =
NULL
))

23 
C⁄sﬁe
::
	`puts
("\nReady Queue isÉmpty\n");

27 
Thªad
 *
ªady_thªad
 = 
ªady_Queue
[
‰⁄t_ödex
];

28 if(
ªady_thªad
 !
NULL
)

30 
thªadInfoSåu˘T
 **
blocked_thªad_queue
 = 
SYSTEM_DISK
->
	`gë_blocked_thªad_queue
();

31 
i
 = 0; i < 
MAX_QUEUE_SIZE
; i++)

33 
Thªad
 * 
thªad
 = 
blocked_thªad_queue
[
i
]->thread;

34 
block_no
 = 
blocked_thªad_queue
[
i
]->block_no;

35 * 
buf„r
 = 
blocked_thªad_queue
[
i
]->buffer;

36 
DISK_OPERATION
 
thªad_›î
 = 
blocked_thªad_queue
[
i
]->
disk_›î
;

43 i‡(
thªad
 =
ªady_thªad
)

45 i‡(
SYSTEM_DISK
->
	`is_devi˚_ªady
())

47 i‡(
thªad_›î
 =
READ
)

49 
SYSTEM_DISK
->
	`ªad_‰om_p‹t
(
block_no
, 
buf„r
);

51 i‡(
thªad_›î
 =
WRITE
)

53 
SYSTEM_DISK
->
	`wrôe_to_p‹t
(
block_no
, 
buf„r
);

58 
	`ªsume
(
thªad
);

59 
	`yõld
();

64 
Thªad
::
	`di•©ch_to
(
ªady_thªad
);

65 
‰⁄t_ödex
 = (‰⁄t_ödex +1 ) % 
MAX_QUEUE_SIZE
;

70 
	}
}

72 
	gScheduÀr
::
	$add
(
Thªad
 *
_thªad
)

74 
C⁄sﬁe
::
	`puts
("AddingáÅhread intoÅheÑeadyQueue");

76 
	`ªsume
(
_thªad
);

78 
	}
}

80 
	gScheduÀr
::
	$ªsume
(
Thªad
 *
_thªad
)

82 i‡–(
√xt_ödex
 =
‰⁄t_ödex
Ë&& (
ªady_Queue
[‰⁄t_ödex] !=
NULL
))

84 
C⁄sﬁe
::
	`puts
("ready Queue is fullÇeedÅo increase size\n");

89 
i
 = 
‰⁄t_ödex
; i !
√xt_ödex
; i = (i+1Ë% 
MAX_QUEUE_SIZE
)

91 i‡(
ªady_Queue
[
i
] =
_thªad
)

93 
C⁄sﬁe
::
	`puts
("ThreadálreadyÉxists inÅheÑeady queue. Not schedulingágain");

97 
ªady_Queue
[
√xt_ödex
] = 
_thªad
;

98 
√xt_ödex
 = (√xt_ödex + 1Ë% 
MAX_QUEUE_SIZE
;

100 
	}
}

102 
	gScheduÀr
::
	$ãrmö©e
(
Thªad
 *
_thªad
)

104 
i
=0,
j
=0,
cou¡
=0;

105 
i
 = 
‰⁄t_ödex
;

107 
C⁄sﬁe
::
	`puts
("Åerminate is called\n");

110 
ªady_Queue
[
i
] !
NULL
 && 
cou¡
 < 
MAX_QUEUE_SIZE
)

113 if(
ªady_Queue
[
i
] =
_thªad
)

116 
i
 = (ò+ 1Ë% 
MAX_QUEUE_SIZE
 ;

117 
cou¡
++;

120 i‡(
cou¡
 =
MAX_QUEUE_SIZE
)

122 
C⁄sﬁe
::
	`puts
(" NoÅhread found withÅhat idÜist is full\n");

126 i‡(
ªady_Queue
[
i
] =
NULL
)

129 
C⁄sﬁe
::
	`puts
(" NoÅhread found withÅhat id\n");

135 
j
 = (
i
+1Ë% 
MAX_QUEUE_SIZE
;

136 
j
 !
√xt_ödex
)

139 
ªady_Queue
[
i
] =Ñódy_Queue[
j
];

140 
j
 = (
i
+1Ë% 
MAX_QUEUE_SIZE
;

141 
i
 = (i+1Ë% 
MAX_QUEUE_SIZE
;

143 
ªady_Queue
[
i
] = 
NULL
;

144 
√xt_ödex
 = 
i
;

149 
	}
}

151 
	gScheduÀr
::
	$¥ötQueue
()

153 
i
 = 
‰⁄t_ödex
; i !
√xt_ödex
; i = (i+1)%
MAX_QUEUE_SIZE
)

155 
Thªad
 *
thªad
 = 
ªady_Queue
[
i
];

156 i‡(
thªad
 !
NULL
)

158 
C⁄sﬁe
::
	`puti
(
thªad
->
	`ThªadId
());

159 
C⁄sﬁe
::
	`puts
(" ");

163 
C⁄sﬁe
::
	`puts
(" NULL ");

166 
	}
}

	@Scheduler.H

11 #i‚de‡
SCHEDULER_H


12 
	#SCHEDULER_H


	)

22 
	~"machöe.H
"

23 
	~"thªad.H
"

26 
	#MAX_QUEUE_SIZE
 1000

	)

32 ˛as†
	cScheduÀr
 {

36 
	mpublic
:

38 
‰⁄t_ödex
;

39 
	m√xt_ödex
;

41 
Thªad
 *
	mªady_Queue
[
MAX_QUEUE_SIZE
];

43 
ScheduÀr
();

48 
vútuÆ
 
yõld
();

54 
vútuÆ
 
ªsume
(
Thªad
 * 
_thªad
);

59 
vútuÆ
 
add
(
Thªad
 * 
_thªad
);

65 
vútuÆ
 
ãrmö©e
(
Thªad
 * 
_thªad
);

69 
¥ötQueue
();

	@assert.C

24 
	~"as£π.H
"

26 
	~"utûs.H
"

27 
	~"c⁄sﬁe.H
"

33 
	$_as£π
 (c⁄° * 
_fûe
, c⁄° 
_löe
, c⁄° * 
_mesßge
 ) {

35 
ãmp
[15];

36 
C⁄sﬁe
::
	`puts
("Assertion failedát file: ");

37 
C⁄sﬁe
::
	`puts
(
_fûe
);

38 
C⁄sﬁe
::
	`puts
("Üine: ");

39 
	`öt2°r
(
_löe
, 
ãmp
);

40 
C⁄sﬁe
::
	`puts
(
ãmp
);

41 
C⁄sﬁe
::
	`puts
("ássertion: ");

42 
C⁄sﬁe
::
	`puts
(
_mesßge
);

43 
C⁄sﬁe
::
	`puts
("\n");

44 
	`ab‹t
();

45 
	}
}

	@assert.H

15 #i‚de‡
__as£π_H__


16 
	#__as£π_H__


	)

22 
	~"utûs.H
"

43 #ifde‡
as£π


44 #unde‡
as£π


47 
_as£π
 ( c⁄° * 
_fûe
, c⁄° 
_löe
, c⁄° * 
_mesßge
 );

49 #ifde‡
NDEBUG


50 
	#as£π
–
m
 ) ( ( Ë0 )

	)

52 
	#as£π
–
m
 ) \

53 i‡–!(
m
ËË
	`_as£π
–
__FILE__
, 
__LINE__
, #m );

	)

	@blocking_disk.C

1 
	~"blockög_disk.H
"

2 
	~"c⁄sﬁe.H
"

3 
	~"machöe.H
"

4 
	~"ScheduÀr.H
"

6 
˛ass
 
	gScheduÀr
;

8 
ScheduÀr
* 
SYSTEM_SCHEDULER
;

10 
	gBlockögDisk
::
	$BlockögDisk
(
DISK_ID
 
disk_id
, 
size
Ë: 
	$Sim∂eDisk
(
disk_id
, 
size
)

16 
i
 = 0 ; i < 
MAX_SIZE
; i++)

18 
thªad_queue
[
i
] = 
NULL
;

24 
‰⁄t_ödex
 = 0;

25 
ª¨_ödex
 = 0;

26 
thªad_cou¡
 = 0;

28 
	}
}

30 
	gBlockögDisk
::
	$ªad
(
block_no
, * 
buf„r
)

32 
	`issue_›î©i⁄
(
READ
, 
block_no
);

33 
Thªad
 * 
cuºít_thªad
 = Thªad::
	`CuºítThªad
();

34 
	`push
(
cuºít_thªad
, 
READ
, 
block_no
, 
buf„r
);

37 
SYSTEM_SCHEDULER
->
	`ªsume
(
cuºít_thªad
);

38 
SYSTEM_SCHEDULER
->
	`yõld
();

39 
	}
}

41 
	gBlockögDisk
::
	$wrôe
(
block_no
, * 
buf„r
)

43 
	`issue_›î©i⁄
(
WRITE
, 
block_no
);

44 
Thªad
 * 
cuºít_thªad
 = Thªad::
	`CuºítThªad
();

45 
	`push
(
cuºít_thªad
, 
WRITE
, 
block_no
, 
buf„r
);

48 
SYSTEM_SCHEDULER
->
	`ªsume
(
cuºít_thªad
);

49 
SYSTEM_SCHEDULER
->
	`yõld
();

50 
	}
}

52 
	gBlockögDisk
::
	$ªad_‰om_p‹t
(
block_no
, * 
_buf
)

55 
i
;

56 
tmpw
;

57 
i
 = 0; i < 256; i++) {

58 
tmpw
 = 
	`öp‹tw
(0x1F0);

59 
_buf
[
i
*2] = ()
tmpw
;

60 
_buf
[
i
*2+1] = ()(
tmpw
 >> 8);

62 
	`p›
();

63 
	}
}

65 
	gBlockögDisk
::
	$wrôe_to_p‹t
(
block_no
, * 
_buf
)

68 
i
;

69 
tmpw
;

70 
i
 = 0; i < 256; i++) {

71 
tmpw
 = 
_buf
[2*
i
] | (_buf[2*i+1] << 8);

72 
	`ouç‹tw
(0x1F0, 
tmpw
);

74 
	`p›
();

75 
	}
}

77 
thªadInfoSåu˘T
 
	gthªad_öfo_°ru˘
;

79 
	gBlockögDisk
::
	$push
(
Thªad
 *
thªad
, 
DISK_OPERATION
 
disk_›î
, 
block_no
, *
buf„r
)

81 i‡(
thªad_cou¡
 > 
MAX_SIZE
)

83 
C⁄sﬁe
::
	`puts
("MaxÅhread countÉxceeded \n");

87 
thªad_öfo_°ru˘
.
thªad
 =Åhread;

88 
thªad_öfo_°ru˘
.
disk_›î
 = disk_oper;

89 
thªad_öfo_°ru˘
.
block_no
 = block_no;

90 
thªad_öfo_°ru˘
.
buf„r
 = buffer;

92 
thªad_queue
[
ª¨_ödex
] = &
thªad_öfo_°ru˘
;

95 
thªad_queue
[
ª¨_ödex
]->
thªad
 =Åhread;

96 
thªad_queue
[
ª¨_ödex
]->
disk_›î
 = disk_oper;

97 
thªad_queue
[
ª¨_ödex
]->
block_no
 = block_no;

98 
thªad_queue
[
ª¨_ödex
]->
buf„r
 = buffer;

101 
ª¨_ödex
 = (ª¨_ödex + 1Ë% 
MAX_SIZE
;

102 
thªad_cou¡
 += 1;

103 
	}
}

105 
	gBlockögDisk
::
	$p›
()

107 i‡(
thªad_cou¡
 == 0)

112 
thªad_queue
[
‰⁄t_ödex
] = 
NULL
;

113 
thªad_cou¡
 -= 1;

114 
‰⁄t_ödex
 = (‰⁄t_ödex + 1Ë% 
MAX_SIZE
;

115 
	}
}

117 
BOOLEAN
 
	gBlockögDisk
::
	$is_devi˚_ªady
()

119  
	`is_ªady
();

120 
	}
}

122 
	gBlockögDisk
::
	$£t_thªad_to_nuŒ
(
Thªad
 * 
thªad
)

124 i‡(
thªad
 =
NULL
)

126 
C⁄sﬁe
::
	`puts
("Thread NULL...returning\n");

130 i‡(
thªad_cou¡
 == 0)

132 
C⁄sﬁe
::
	`puts
("No blockedÅhread in queue \n");

135 
i
 = 0 ; i < 
MAX_SIZE
; i++)

137 i‡(
thªad_queue
[
i
]->
thªad
 ==Åhread)

139 
thªad_queue
[
i
] = 
NULL
;

142 
	}
}

144 
thªadInfoSåu˘T
** 
	gBlockögDisk
::
	$gë_blocked_thªad_queue
()

146  
thªad_queue
;

147 
	}
}

	@blocking_disk.H

1 #i‚de‡
__BLOCKING_DEV_H__


2 
	#__BLOCKING_DEV_H__


	)

4 
	~"sim∂e_disk.H
"

5 
	~"thªad.H
"

7 
	#MAX_SIZE
 20

	)

9 
	sthªad_öfo


11 
Thªad
 * 
	mthªad
;

12 
DISK_OPERATION
 
	mdisk_›î
;

13 
	mblock_no
;

14 *
	mbuf„r
;

15 }
	tthªadInfoSåu˘T
;

17 ˛as†
	cBlockögDisk
 : 
public
 
Sim∂eDisk


19 
thªadInfoSåu˘T
 * 
thªad_queue
[
MAX_SIZE
];

20 
	m‰⁄t_ödex
;

21 
	mª¨_ödex
;

22 
	mthªad_cou¡
;

24 
	mpublic
:

25 
BlockögDisk
(
DISK_ID
 
_disk_id
, 
_size
);

29 
ªad
(
_block_no
, * 
_buf
);

32 
wrôe
(
_block_no
, * 
_buf
);

35 
ªad_‰om_p‹t
(
_block_no
, *
_buf
);

36 
wrôe_to_p‹t
(
_block_no
, *
_buf
);

40 
push
(
Thªad
 *
thªad
, 
DISK_OPERATION
 
disk_›í
, 
_block_no
, *
buf„r
);

43 
p›
();

46 
BOOLEAN
 
is_devi˚_ªady
();

48 
£t_thªad_to_nuŒ
(
Thªad
* 
thªad
);

51 
thªadInfoSåu˘T
** 
gë_blocked_thªad_queue
();

	@console.C

15 
	#CONSOLE_START_ADDRESS
 (*)0xB8000

	)

21 
	~"c⁄sﬁe.H
"

23 
	~"utûs.H
"

49 
	gC⁄sﬁe
::
©åib
;

50 
	gC⁄sﬁe
::
c§_x
;

51 
	gC⁄sﬁe
::
c§_y
;

52 * 
	gC⁄sﬁe
::
ãxtmem±r
;

56 
	gC⁄sﬁe
::
	$öô
(
_f‹e_cﬁ‹
,

57 
_back_cﬁ‹
) {

58 
	`£t_TextCﬁ‹
(
_f‹e_cﬁ‹
, 
_back_cﬁ‹
);

59 
c§_x
 = 0;

60 
c§_y
 = 0;

61 
ãxtmem±r
 = 
CONSOLE_START_ADDRESS
;

62 
	`˛s
();

63 
	}
}

66 
	gC⁄sﬁe
::
	$s¸ﬁl
() {

70 
bœnk
 = 0x20 | (
©åib
 << 8);

73 if(
c§_y
 >= 25)

77 
ãmp
 = 
c§_y
 - 25 + 1;

78 
	`mem˝y
 ((*)
ãxtmem±r
, (*)—extmem±∏+ 
ãmp
 * 80), (25 -Åemp) * 80 * 2);

82 
	`mem£tw
 (
ãxtmem±r
 + (25 - 
ãmp
Ë* 80, 
bœnk
, 80);

83 
c§_y
 = 25 - 1;

85 
	}
}

88 
	gC⁄sﬁe
::
	$move_curs‹
() {

93 
ãmp
 = 
c§_y
 * 80 + 
c§_x
;

102 
	`ouç‹tb
(0x3D4, ()14);

104 
	`ouç‹tb
(0x3D4, 15);

106 
	}
}

109 
	gC⁄sﬁe
::
	$˛s
() {

113 
bœnk
 = 0x20 | (
©åib
 << 8);

117 
i
 = 0; i < 25; i++)

118 
	`mem£tw
 (
ãxtmem±r
 + 
i
 * 80, 
bœnk
, 80);

122 
c§_x
 = 0;

123 
c§_y
 = 0;

124 
	`move_curs‹
();

125 
	}
}

128 
	gC⁄sﬁe
::
	$putch
(c⁄° 
_c
){

132 if(
_c
 == 0x08)

134 if(
c§_x
 != 0) csr_x--;

138 if(
_c
 == 0x09)

140 
c§_x
 = (csr_x + 8) & ~(8 - 1);

144 if(
_c
 == '\r')

146 
c§_x
 = 0;

151 if(
_c
 == '\n')

153 
c§_x
 = 0;

154 
c§_y
++;

160 if(
_c
 >= ' ')

162 * 
whîe
 = 
ãxtmem±r
 + (
c§_y
 * 80 + 
c§_x
);

163 *
whîe
 = 
_c
 | (
©åib
 << 8);

164 
c§_x
++;

169 if(
c§_x
 >= 80)

171 
c§_x
 = 0;

172 
c§_y
++;

176 
	`s¸ﬁl
();

177 
	`move_curs‹
();

178 
	}
}

181 
	gC⁄sﬁe
::
	$puts
(c⁄° * 
_s
) {

183 
i
 = 0; i < 
	`°æí
(
_s
); i++) {

184 
	`putch
(
_s
[
i
]);

186 
	}
}

188 
	gC⁄sﬁe
::
	$puti
(c⁄° 
_n
) {

189 
foo°r
[15];

191 
	`öt2°r
(
_n
, 
foo°r
);

192 
	`puts
(
foo°r
);

193 
	}
}

195 
	gC⁄sﬁe
::
	$putui
(c⁄° 
_n
) {

196 
foo°r
[15];

198 
	`uöt2°r
(
_n
, 
foo°r
);

199 
	`putch
('<');

200 
	`puts
(
foo°r
);

201 
	`putch
('>');

202 
	}
}

206 
	gC⁄sﬁe
::
	$£t_TextCﬁ‹
(c⁄° 
_f‹ecﬁ‹
,

207 c⁄° 
_backcﬁ‹
) {

210 
©åib
 = (
_backcﬁ‹
 << 4Ë| (
_f‹ecﬁ‹
 & 0x0F);

211 
	}
}

	@console.H

24 #i‚de‡
_C⁄sﬁe_H_


25 
	#_C⁄sﬁe_H_


	)

44 
	mBLACK
 = 0,

45 
	mBLUE
 = 1,

46 
	mGREEN
 = 2,

47 
	mCYAN
 = 3,

48 
	mRED
 = 4,

49 
	mMAGENTA
 = 5,

50 
	mBROWN
 = 6,

51 
	mLIGHT_GREY
 = 7,

52 
	mDARK_GREY
 = 8,

53 
	mLIGHT_BLUE
 = 9,

54 
	mLIGHT_GREEN
 = 10,

55 
	mLIGHT_CYAN
 = 11,

56 
	mLIGHT_RED
 = 12,

57 
	mLIGHT_MAGENTA
 = 13,

58 
	mLIGHT_BROWN
 = 14,

59 
	mWHITE
 = 15

60 } 
	tCOLOR_CODE
;

73 ˛as†
	cC⁄sﬁe
 {

74 
	m¥iv©e
:

75 
©åib
;

76 
	mc§_x
;

77 
	mc§_y
;

78 * 
	mãxtmem±r
;

79 
	mpublic
:

82 
öô
(
_f‹e_cﬁ‹
 = 
WHITE
,

83 
_back_cﬁ‹
 = 
BLACK
);

85 
s¸ﬁl
();

87 
move_curs‹
();

90 
˛s
();

93 
putch
(c⁄° 
_c
);

96 
puts
(c⁄° * 
_s
);

99 
puti
(c⁄° 
_i
);

102 
putui
(c⁄° 
_u
);

105 
£t_TextCﬁ‹
(
_f‹e_cﬁ‹
, 
_back_cﬁ‹
);

	@exceptions.C

21 
	~"as£π.H
"

22 
	~"utûs.H
"

23 
	~"c⁄sﬁe.H
"

24 
	~"idt.H
"

25 
	~"ex˚±i⁄s.H
"

39 "C" 
i§0
();

40 "C" 
i§1
();

41 "C" 
i§2
();

42 "C" 
i§3
();

43 "C" 
i§4
();

44 "C" 
i§5
();

45 "C" 
i§6
();

46 "C" 
i§7
();

47 "C" 
i§8
();

48 "C" 
i§9
();

49 "C" 
i§10
();

50 "C" 
i§11
();

51 "C" 
i§12
();

52 "C" 
i§13
();

53 "C" 
i§14
();

54 "C" 
i§15
();

55 "C" 
i§16
();

56 "C" 
i§17
();

57 "C" 
i§18
();

58 "C" 
i§19
();

59 "C" 
i§20
();

60 "C" 
i§21
();

61 "C" 
i§22
();

62 "C" 
i§23
();

63 "C" 
i§24
();

64 "C" 
i§25
();

65 "C" 
i§26
();

66 "C" 
i§27
();

67 "C" 
i§28
();

68 "C" 
i§29
();

69 "C" 
i§30
();

70 "C" 
i§31
();

72 "C" 
	$lowÀvñ_di•©ch_ex˚±i⁄
(
REGS
 * 
_r
) {

73 
Ex˚±i⁄H™dÀr
::
	`di•©ch_ex˚±i⁄
(
_r
);

74 
	}
}

80 
Ex˚±i⁄H™dÀr
 * Ex˚±i⁄H™dÀr::
h™dÀr_èbÀ
[Ex˚±i⁄H™dÀr::
EXCEPTION_TABLE_SIZE
];

86 
	gEx˚±i⁄H™dÀr
::
	$öô_di•©chî
() {

90 
IDT
::
	`£t_g©e
–0, (Ë
i§0
, 0x08, 0x8E);

91 
IDT
::
	`£t_g©e
–1, (Ë
i§1
, 0x08, 0x8E);

92 
IDT
::
	`£t_g©e
–2, (Ë
i§2
, 0x08, 0x8E);

93 
IDT
::
	`£t_g©e
–3, (Ë
i§3
, 0x08, 0x8E);

94 
IDT
::
	`£t_g©e
–4, (Ë
i§4
, 0x08, 0x8E);

95 
IDT
::
	`£t_g©e
–5, (Ë
i§5
, 0x08, 0x8E);

96 
IDT
::
	`£t_g©e
–6, (Ë
i§6
, 0x08, 0x8E);

97 
IDT
::
	`£t_g©e
–7, (Ë
i§7
, 0x08, 0x8E);

99 
IDT
::
	`£t_g©e
–8, (Ë
i§8
, 0x08, 0x8E);

100 
IDT
::
	`£t_g©e
–9, (Ë
i§9
, 0x08, 0x8E);

101 
IDT
::
	`£t_g©e
(10, ()
i§10
, 0x08, 0x8E);

102 
IDT
::
	`£t_g©e
(11, ()
i§11
, 0x08, 0x8E);

103 
IDT
::
	`£t_g©e
(12, ()
i§12
, 0x08, 0x8E);

104 
IDT
::
	`£t_g©e
(13, ()
i§13
, 0x08, 0x8E);

105 
IDT
::
	`£t_g©e
(14, ()
i§14
, 0x08, 0x8E);

106 
IDT
::
	`£t_g©e
(15, ()
i§15
, 0x08, 0x8E);

108 
IDT
::
	`£t_g©e
(16, ()
i§16
, 0x08, 0x8E);

109 
IDT
::
	`£t_g©e
(17, ()
i§17
, 0x08, 0x8E);

110 
IDT
::
	`£t_g©e
(18, ()
i§18
, 0x08, 0x8E);

111 
IDT
::
	`£t_g©e
(19, ()
i§19
, 0x08, 0x8E);

112 
IDT
::
	`£t_g©e
(20, ()
i§20
, 0x08, 0x8E);

113 
IDT
::
	`£t_g©e
(21, ()
i§21
, 0x08, 0x8E);

114 
IDT
::
	`£t_g©e
(22, ()
i§22
, 0x08, 0x8E);

115 
IDT
::
	`£t_g©e
(23, ()
i§23
, 0x08, 0x8E);

117 
IDT
::
	`£t_g©e
(24, ()
i§24
, 0x08, 0x8E);

118 
IDT
::
	`£t_g©e
(25, ()
i§25
, 0x08, 0x8E);

119 
IDT
::
	`£t_g©e
(26, ()
i§26
, 0x08, 0x8E);

120 
IDT
::
	`£t_g©e
(27, ()
i§27
, 0x08, 0x8E);

121 
IDT
::
	`£t_g©e
(28, ()
i§28
, 0x08, 0x8E);

122 
IDT
::
	`£t_g©e
(29, ()
i§29
, 0x08, 0x8E);

123 
IDT
::
	`£t_g©e
(30, ()
i§30
, 0x08, 0x8E);

124 
IDT
::
	`£t_g©e
(31, ()
i§31
, 0x08, 0x8E);

127 
i
;

128 
i
 = 0; i < 
EXCEPTION_TABLE_SIZE
; i++) {

129 
h™dÀr_èbÀ
[
i
] = 
NULL
;

131 
	}
}

133 
	gEx˚±i⁄H™dÀr
::
	$di•©ch_ex˚±i⁄
(
REGS
 * 
_r
) {

136 
exc_no
 = 
_r
->
öt_no
;

138 
C⁄sﬁe
::
	`puts
("EXCEPTION DISPATCHER:Éxc_no = ");

139 
C⁄sﬁe
::
	`putui
(
exc_no
);

140 
C⁄sﬁe
::
	`puts
("\n");

142 
	`as£π
((
exc_no
 >0Ë&& (exc_nÿ< 
EXCEPTION_TABLE_SIZE
));

145 
Ex˚±i⁄H™dÀr
 * 
h™dÀr
 = 
h™dÀr_èbÀ
[
exc_no
];

147 i‡(!
h™dÀr
) {

149 
C⁄sﬁe
::
	`puts
("NO DEFAULT EXCEPTION HANDLER REGISTERED\n");

150 
	`ab‹t
();

154 
h™dÀr
->
	`h™dÀ_ex˚±i⁄
(
_r
);

157 
	}
}

159 
	gEx˚±i⁄H™dÀr
::
	$ªgi°î_h™dÀr
(
_i§_code
,

160 
Ex˚±i⁄H™dÀr
 * 
_h™dÀr
) {

162 
	`as£π
(
_i§_code
 >0 && _i§_codê< 
EXCEPTION_TABLE_SIZE
);

164 
h™dÀr_èbÀ
[
_i§_code
] = 
_h™dÀr
;

166 
C⁄sﬁe
::
	`puts
("InstalledÉxception handlerát ISR ");

167 
C⁄sﬁe
::
	`putui
(
_i§_code
);

168 
C⁄sﬁe
::
	`puts
("\n");

170 
	}
}

172 
	gEx˚±i⁄H™dÀr
::
	$dîegi°î_h™dÀr
(
_i§_code
) {

173 
	`as£π
(
_i§_code
 >0 && _i§_codê< 
EXCEPTION_TABLE_SIZE
);

175 
h™dÀr_èbÀ
[
_i§_code
] = 
NULL
;

177 
C⁄sﬁe
::
	`puts
("UNINSTALLEDÉxception handlerát ISR ");

178 
C⁄sﬁe
::
	`putui
(
_i§_code
);

179 
C⁄sﬁe
::
	`puts
("\n");

181 
	}
}

	@exceptions.H

23 #i‚de‡
_ex˚±i⁄s_H_


24 
	#_ex˚±i⁄s_H_


	)

30 
	~"utûs.H
"

31 
	~"as£π.H
"

32 
	~"machöe.H
"

38 ˛as†
	cEx˚±i⁄H™dÀr
 {

40 
	m¥iv©e
:

43 c⁄° 
EXCEPTION_TABLE_SIZE
 = 32;

44 
Ex˚±i⁄H™dÀr
 * 
	mh™dÀr_èbÀ
[
EXCEPTION_TABLE_SIZE
];

46 
	mpublic
:

50 
ªgi°î_h™dÀr
(
_i§_code
,

51 
Ex˚±i⁄H™dÀr
 * 
_h™dÀr
);

58 
dîegi°î_h™dÀr
(
_i§_code
);

61 
öô_di•©chî
();

67 
di•©ch_ex˚±i⁄
(
REGS
 * 
_r
);

75 
vútuÆ
 
	$h™dÀ_ex˚±i⁄
(
REGS
 * 
_ªgs
) {

76 
	`as£π
(
FALSE
);

81 
	}
};

	@file_system.C

1 
	~"fûe_sy°em.H
"

2 
	~"c⁄sﬁe.H
"

7 
	gFûe
::
	$Fûe
()

12 
cuºít_posôi⁄
 = 0;

13 
cuºít_block
 = -1;

14 
°¨tög_block
 = -1;

15 
fûe_size
 = 0;

16 
fûe_id
 = -1;

17 
cuºít_block_ödex
 = 1;

18 
fûe_blocks
 = 
NULL
;

19 
	}
}

21 
	gFûe
::
	$Ród
(
n
, * 
buf„r
)

23 i‡(
cuºít_block
 =-1 || 
°¨tög_block
 == -1)

25 
C⁄sﬁe
::
	`puts
("File hasÇot been initialized\n");

29 
fûe_blocks
 = 
fûe_sy°em
->
	`GëFûeBlocks
(
fûe_id
);

30 
numbî_of_ch¨_ªad
 = 0;

31 
cuºít_block
 = 
fûe_blocks
[
cuºít_block_ödex
 - 1];

32 
block_d©a
[
BLOCK_SIZE
];

33 
fûe_sy°em
->
disk
->
	`ªad
(
cuºít_block
, 
block_d©a
);

35 
n
 > 0 && !
	`EoF
())

37 
buf„r
[
numbî_of_ch¨_ªad
] = 
block_d©a
[
cuºít_posôi⁄
];

38 
numbî_of_ch¨_ªad
++;

39 
cuºít_posôi⁄
++;

40 i‡(
cuºít_posôi⁄
 >
BLOCK_SIZE
)

42 
cuºít_posôi⁄
 = 0;

43 
cuºít_block_ödex
++;

44 i‡(
cuºít_block_ödex
 >= 10)

49  
numbî_of_ch¨_ªad
;

51 
cuºít_block
 = 
fûe_blocks
[
cuºít_block_ödex
 - 1];

52 
fûe_sy°em
->
disk
->
	`ªad
(
cuºít_block
, 
block_d©a
);

54 
n
--;

56  
numbî_of_ch¨_ªad
;

57 
	}
}

59 
	gFûe
::
	$Wrôe
(
n
, * 
buf„r
)

61 i‡(
cuºít_block
 =-1 || 
°¨tög_block
 == -1)

63 
C⁄sﬁe
::
	`puts
("File hasÇot been initialized\n");

67 
posôi⁄
 = 
cuºít_posôi⁄
;

68 
block_to_wrôe
 = 
cuºít_block
;

69 
ch¨_wrôãn
 = 0;

70 
numbî_of_√w_blocks
 = 0;

71 
cuº_block_d©a
[
BLOCK_SIZE
];

72 
fûe_sy°em
->
disk
->
	`ªad
(
block_to_wrôe
, 
cuº_block_d©a
);

73 
ch¨_wrôãn
 < 
n
 || 
buf„r
[char_written] == '\0')

75 
cuº_block_d©a
[
posôi⁄
] = 
buf„r
[
ch¨_wrôãn
];

76 
posôi⁄
++;

77 
ch¨_wrôãn
++;

78 if(
posôi⁄
 >
BLOCK_SIZE
)

80 
numbî_of_√w_blocks
++;

81 
fûe_sy°em
->
disk
->
	`wrôe
(
block_to_wrôe
, 
cuº_block_d©a
);

89 
cuº_block_d©a
[
posôi⁄
++] = -1;

90 
fûe_sy°em
->
disk
->
	`wrôe
(
block_to_wrôe
, 
cuº_block_d©a
);

91  
ch¨_wrôãn
;

92 
	}
}

94 
	gFûe
::
	$Re£t
()

96 
cuºít_posôi⁄
 = 0;

97 
cuºít_block
 = 
°¨tög_block
;

98 
	}
}

100 
	gFûe
::
	$Rewrôe
()

102 
buf
[
BLOCK_SIZE
];

103 
	`mem£t
(
buf
, 0, 
BLOCK_SIZE
);

104 
i
 = 0; i < 10; i++)

106 i‡(
fûe_blocks
[
i
] != 0)

108 
fûe_sy°em
->
disk
->
	`wrôe
(
fûe_blocks
[
i
], 
buf
);

109 
fûe_sy°em
->
	`Rñó£Block
(
fûe_blocks
[
i
]);

110 
fûe_blocks
[
i
] = 0;

117 
	}
}

119 
BOOLEAN
 
	gFûe
::
	$EoF
()

121 
block_d©a
[
BLOCK_SIZE
];

122 
fûe_sy°em
->
disk
->
	`ªad
(
cuºít_block
, 
block_d©a
);

123 if(
block_d©a
[
cuºít_posôi⁄
] == -1)

125  
TRUE
;

129  
FALSE
;

131 
	}
}

133 
	gFûe
::
	$PrötFûeAâribuãs
()

135 
C⁄sﬁe
::
	`puts
("\n");

136 
C⁄sﬁe
::
	`puts
("Current Position : ");

137 
C⁄sﬁe
::
	`puti
(
cuºít_posôi⁄
);

138 
C⁄sﬁe
::
	`puts
("\n");

140 
C⁄sﬁe
::
	`puts
("Starting Block : ");

141 
C⁄sﬁe
::
	`puti
(
°¨tög_block
);

142 
C⁄sﬁe
::
	`puts
("\n");

144 
C⁄sﬁe
::
	`puts
("Current Block : ");

145 
C⁄sﬁe
::
	`puti
(
cuºít_block
);

146 
C⁄sﬁe
::
	`puts
("\n");

148 
C⁄sﬁe
::
	`puts
("File Size : ");

149 
C⁄sﬁe
::
	`puti
(
fûe_size
);

150 
C⁄sﬁe
::
	`puts
("\n");

152 
C⁄sﬁe
::
	`puts
("File ID: ");

153 
C⁄sﬁe
::
	`puti
(
fûe_id
);

154 
C⁄sﬁe
::
	`puts
("\n");

156 
C⁄sﬁe
::
	`puts
("Current Block Index: ");

157 
C⁄sﬁe
::
	`puti
(
cuºít_block_ödex
);

158 
C⁄sﬁe
::
	`puts
("\n");

160 
	}
}

169 
Sim∂eDisk
 * 
	gFûeSy°em
::
disk
;

170 
	gFûeSy°em
::
size
;

171 
BOOLEAN
 
	gFûeSy°em
::
is_mou¡ed
;

172 * 
	gFûeSy°em
::
‰ì_block_m≠
;

173 
	gFûeSy°em
::
numbî_of_blocks
;

174 
	gFûeSy°em
::
numbî_of_öodes
;

175 
	gFûeSy°em
::
öode_mgmt_blocks
;

177 
	gFûeSy°em
::
	$FûeSy°em
()

179 
FûeSy°em
::
disk
 = 
NULL
;

180 
is_mou¡ed
 = 
FALSE
;

181 
size
 = 0;

182 
	}
}

184 
BOOLEAN
 
	gFûeSy°em
::
	$Mou¡
(
Sim∂eDisk
 *
_disk
)

186 i‡(
_disk
 && !
is_mou¡ed
)

188 
FûeSy°em
::
is_mou¡ed
 = 
TRUE
;

189 
FûeSy°em
::
disk
 = 
_disk
;

190  
TRUE
;

193  
FALSE
;

194 
	}
}

196 
BOOLEAN
 
	gFûeSy°em
::
	$F‹m©
(
Sim∂eDisk
 *
_disk
, 
size
)

198 i‡(
size
 > 
MAX_DISK_SIZE
)

200 
C⁄sﬁe
::
	`puts
("File system size cannotÉxceed maximum disk size! Exiting\n");

201  
FALSE
;

203 
FûeSy°em
::
disk
 = 
_disk
;

204 
FûeSy°em
::
size
 = size;

205 
FûeSy°em
::
numbî_of_blocks
 = 
size
 / 
BLOCK_SIZE
;

206 
	`mem£t
(
‰ì_block_m≠
, 0, ((
FûeSy°em
::
numbî_of_blocks
)/32) * ());

208 
buf„r
[
BLOCK_SIZE
];

209 
	`mem£t
(
buf„r
, 0, 
BLOCK_SIZE
);

211 
i
 = 0 ; i < 
FûeSy°em
::
numbî_of_blocks
; i++)

213 
FûeSy°em
::
disk
->
	`wrôe
(
i
, 
buf„r
);

217 
FûeSy°em
::
numbî_of_öodes
 = FûeSy°em::
numbî_of_blocks
 / 10;

224 
FûeSy°em
::
öode_mgmt_blocks
 = (
numbî_of_öodes
 * (
INode_T
)Ë/ 
BLOCK_SIZE
 ;

226 
C⁄sﬁe
::
	`puts
("Number of inodes = ");

227 
C⁄sﬁe
::
	`puti
(
FûeSy°em
::
numbî_of_öodes
);

228 
C⁄sﬁe
::
	`puts
("\n");

230 
C⁄sﬁe
::
	`puts
("Size of Inode = ");

231 
C⁄sﬁe
::
	`puti
((
INode_T
));

232 
C⁄sﬁe
::
	`puts
("\n");

234 
C⁄sﬁe
::
	`puts
("Number of inode mgmt blocks = ");

235 
C⁄sﬁe
::
	`puti
(
FûeSy°em
::
öode_mgmt_blocks
);

236 
C⁄sﬁe
::
	`puts
("\n");

238 
numbî_of_fuŒ_‰ames
 = 
öode_mgmt_blocks
 / 32;

239 
À·_ovî
 = 
öode_mgmt_blocks
 % 32;

241 
i
 = 0;

242 
i
 = 0; i < 
numbî_of_fuŒ_‰ames
; i++)

243 
‰ì_block_m≠
[
i
] = 0xFFFFFFFF;

245 
j
 = 0; j < 
À·_ovî
; j++)

246 
‰ì_block_m≠
[
i
] = 
	`SET_BIT
(‰ì_block_m≠[i], 
j
);

248  
TRUE
;

249 
	}
}

251 
BOOLEAN
 
	gFûeSy°em
::
	$LookupFûe
(
fûe_id
, 
Fûe
 *
fûe
)

253 
buf„r
[
BLOCK_SIZE
];

254 
i
 = 0; i < 
öode_mgmt_blocks
; i++)

256 
disk
->
	`ªad
(
i
, 
buf„r
);

257 
INode_T
 *
öode_li°
 = (INode_T*Ë
buf„r
;

258 
numbî_of_öodes_ö_li°
 = 
BLOCK_SIZE
/(
INode_T
);

259 
j
 = 0; j < 
numbî_of_öodes_ö_li°
; j++)

261 i‡(
öode_li°
[
j
].
fûe_id
 == file_id)

264 
fûe
->
cuºít_posôi⁄
 = 0;

265 
fûe
->
fûe_size
 = 0;

266 
fûe
->
cuºít_block_ödex
 = 1;

268 
fûe
->
°¨tög_block
 = 
öode_li°
[
j
].
block_no
[0];

269 
fûe
->
cuºít_block
 = 
öode_li°
[
j
].
block_no
[0];

270 
fûe
->
fûe_id
 = file_id;

271 
fûe
->
fûe_sy°em
 = 
this
;

272 
fûe
->
fûe_blocks
 = 
	`GëFûeBlocks
(
fûe_id
);

274  
TRUE
;

278  
FALSE
;

279 
	}
}

281 
BOOLEAN
 
	gFûeSy°em
::
	$Cª©eFûe
(
fûe_id
)

283 if(!
is_mou¡ed
 || 
fûe_id
 == 0)

285 
C⁄sﬁe
::
	`puts
("File systemÇot mounted or invalid file ID!! Returning\n");

286  
FALSE
;

289 
Fûe
 *
fûe
;

290 if(
	`LookupFûe
(
fûe_id
, 
fûe
))

292 
C⁄sﬁe
::
	`puts
("FileálreadyÉxists! Not creatingágain\n");

293  
FALSE
;

296 
buf„r
[
BLOCK_SIZE
];

297 
i
 = 0; i < 
öode_mgmt_blocks
; i++)

299 
disk
->
	`ªad
(
i
, 
buf„r
);

300 
INode_T
 *
öode_li°
 = (INode_T*)
buf„r
;

301 
numbî_of_öodes_ö_li°
 = 
BLOCK_SIZE
/(
INode_T
);

302 
j
 = 0; j < 
numbî_of_öodes_ö_li°
; j++)

304 i‡(
öode_li°
[
j
].
fûe_id
 == 0)

306 
öode_li°
[
j
].
fûe_id
 = file_id;

307 
öode_li°
[
j
].
fûe_size
 = 0;

308 
öode_li°
[
j
].
block_no
[0] = 
	`GëFªeBlockNumbî
();

309 
öode_li°
[
j
].
numbî_of_blocks_u£d
 = 0;

310 
disk
->
	`wrôe
(
i
, 
buf„r
);

311  
TRUE
;

315  
FALSE
;

316 
	}
}

318 
BOOLEAN
 
	gFûeSy°em
::
	$DñëeFûe
(
fûe_id
)

320 if(!
is_mou¡ed
 || 
fûe_id
 == 0)

322 
C⁄sﬁe
::
	`puts
("File systemÇot mounted or invalid file ID!! Returning\n");

323  
FALSE
;

326 
buf„r
[
BLOCK_SIZE
];

327 
i
 = 0; i < 
öode_mgmt_blocks
; i++)

329 
disk
->
	`ªad
(
i
, 
buf„r
);

330 
INode_T
 *
öode_li°
 = (INode_T*)
buf„r
;

331 
numbî_of_öodes_ö_li°
 = 
BLOCK_SIZE
/(
INode_T
);

332 
j
 = 0; j < 
numbî_of_öodes_ö_li°
; j++)

334 i‡(
öode_li°
[
j
].
fûe_id
 == file_id)

336 
öode_li°
[
j
].
fûe_id
 = 0;

337 
öode_li°
[
j
].
fûe_size
 = 0;

338 
k
 = 0; k < 10; k++)

340 i‡(
öode_li°
[
j
].
block_no
[
k
])

341 
	`Rñó£Block
(
öode_li°
[
j
].
block_no
[
k
]);

342 
öode_li°
[
j
].
block_no
[
k
] = 0;

344 
öode_li°
[
j
].
numbî_of_blocks_u£d
 = 0;

345 
disk
->
	`wrôe
(
i
, 
buf„r
);

346  
TRUE
;

350  
FALSE
;

351 
	}
}

353 
	gFûeSy°em
::
	$GëFªeBlockNumbî
()

355 
BOOLEAN
 
block_found
 = 
Ál£
;

356 
i
, 
j
;

357 
block_numbî
;

358  
i
 = 0 ; i < 
numbî_of_blocks
 / 32; i++)

360 i‡(
‰ì_block_m≠
[
i
] != 0xFFFFFFFF)

362  
j
 = 0; j <= 31; j++ )

364 i‡(
	`IS_SET
(
‰ì_block_m≠
[
i
], 
j
))

368 
‰ì_block_m≠
[
i
] = 
	`TOGGLE_BIT
(‰ì_block_m≠[i], 
j
);

369 
block_found
 = 
åue
;

373 i‡(
block_found
)

377 i‡(
block_found
)

379 
block_numbî
 = 
j
 + 
i
*32;

380  
block_numbî
;

386 
	}
}

388 
	gFûeSy°em
::
	$Rñó£Block
(
block_no
)

390 
bô_posôi⁄
 = 
block_no
 % 32;

391 
ödex_of_‰ame
 = 
block_no
 / 32;

392 i‡(
	`IS_SET
 (
‰ì_block_m≠
[
ödex_of_‰ame
], 
bô_posôi⁄
))

394 
‰ì_block_m≠
[
ödex_of_‰ame
] = 
	`TOGGLE_BIT
(‰ì_block_m≠[ödex_of_‰ame], 
bô_posôi⁄
);

396 
	}
}

398 * 
	gFûeSy°em
::
	$GëFûeBlocks
(
fûe_id
)

400 
buf„r
[
BLOCK_SIZE
];

401 
i
 = 0; i < 
öode_mgmt_blocks
; i++)

403 
disk
->
	`ªad
(
i
, 
buf„r
);

404 
INode_T
 *
öode_li°
 = (INode_T*Ë
buf„r
;

405 
numbî_of_öodes_ö_li°
 = 
BLOCK_SIZE
/(
INode_T
);

406 
j
 = 0; j < 
numbî_of_öodes_ö_li°
; j++)

408 i‡(
öode_li°
[
j
].
fûe_id
 == file_id)

410  
öode_li°
[
j
].
block_no
;

414  
NULL
;

416 
	}
}

	@file_system.H

14 #i‚de‡
_FILE_SYSTEM_H_


15 
	#_FILE_SYSTEM_H_


	)

21 
	#MB
 * (0x1 << 20)

	)

22 
	#KB
 * (0x1 << 10)

	)

23 
	#MAX_DISK_SIZE
 ((10 
MB
))

	)

24 
	#BLOCK_SIZE
 512

	)

25 
	#MAX_NUMBER_OF_BLOCKS
 ( (
MAX_DISK_SIZE
Ë/ (
BLOCK_SIZE
Ë)

	)

27 
	#IS_SET
(
v¨
, 
pos
Ë((v¨Ë& (1<<’os)))

	)

28 
	#SET_BIT
(
v¨
, 
pos
Ë((v¨Ë|(1<<’os)))

	)

29 
	#TOGGLE_BIT
(
v¨
, 
pos
Ë((v¨Ë^(1<<’os)))

	)

36 
	~"utûs.H
"

37 
	~"sim∂e_disk.H
"

42 
	sINode


44 
	mfûe_id
;

45 
	mfûe_size
;

46 
	mblock_no
[10];

47 
	mnumbî_of_blocks_u£d
;

48 }
	tINode_T
;

54 
˛ass
 
	gFûeSy°em
;

60 ˛as†
	cFûe
 {

61 
‰õnd
 
˛ass
 
	mFûeSy°em
;

62 
	m¥iv©e
:

65 
cuºít_posôi⁄
;

66 
	m°¨tög_block
;

67 
	mcuºít_block
;

68 
	mcuºít_block_ödex
;

69 * 
	mfûe_blocks
;

70 
	mfûe_size
;

71 
FûeSy°em
 * 
	mfûe_sy°em
;

72 
	mˇched_block
[
BLOCK_SIZE
];

73 
	mfûe_id
;

81 
	mpublic
:

83 
Fûe
();

87 
Ród
(
_n
, * 
_buf
);

92 
Wrôe
(
_n
, * 
_buf
);

98 
Re£t
();

101 
Rewrôe
();

106 
BOOLEAN
 
EoF
();

110 
PrötFûeAâribuãs
();

118 ˛as†
	cFûeSy°em
 {

120 
‰õnd
 
˛ass
 
	mFûe
;

122 
	m¥iv©e
:

125 
Sim∂eDisk
 * 
disk
;

126 
	msize
;

127 
BOOLEAN
 
	mis_mou¡ed
;

128 * 
	m‰ì_block_m≠
;

129 
	mnumbî_of_blocks
;

130 
	mnumbî_of_öodes
;

131 
	möode_mgmt_blocks
;

133 
	mpublic
:

135 
FûeSy°em
();

138 
BOOLEAN
 
Mou¡
(
Sim∂eDisk
 * 
_disk
);

143 
BOOLEAN
 
F‹m©
(
Sim∂eDisk
 * 
_disk
, 
_size
);

147 
BOOLEAN
 
LookupFûe
(
_fûe_id
, 
Fûe
 * 
_fûe
);

151 
BOOLEAN
 
Cª©eFûe
(
_fûe_id
);

155 
BOOLEAN
 
DñëeFûe
(
_fûe_id
);

160 
GëFªeBlockNumbî
();

161 
Rñó£Block
(
block_no
);

165 * 
GëFûeBlocks
(
_fûe_id
);

	@frame_pool.C

23 
	~"utûs.H
"

24 
	~"machöe.H
"

25 
	~"c⁄sﬁe.H
"

27 
	~"‰ame_poﬁ.H
"

33 
	g√xt_‰ì_‰ame
;

39 
	gFømePoﬁ
::
	$FømePoﬁ
() {

40 
√xt_‰ì_‰ame
 = 0x200000;

41 
	}
}

44 
	gFømePoﬁ
::
	$gë_‰ame
() {

49 
√w_‰ame
 = 
√xt_‰ì_‰ame
;

51 
√xt_‰ì_‰ame
 +
PAGE_SIZE
;

53  
√w_‰ame
;

55 
	}
}

58 
	gFømePoﬁ
::
	$ªÀa£_‰ame
(
_‰ame_addªss
) {

63 
	}
}

	@frame_pool.H

14 #i‚de‡
_FRAME_POOL_H_


15 
	#_FRAME_POOL_H_


	)

39 ˛as†
	cFømePoﬁ
 {

41 
	mpublic
:

43 
FømePoﬁ
();

48 
gë_‰ame
();

52 
ªÀa£_‰ame
(
_‰ame_addªss
);

	@gdt.C

35 
	~"utûs.H
"

36 
	~"gdt.H
"

45 
	sgdt_íåy
 {

46 
	mlimô_low
;

47 
	mba£_low
;

48 
	mba£_middÀ
;

49 
	mac˚ss
;

50 
	mgønuœrôy
;

51 
	mba£_high
;

52 } 
__©åibuã__
((
∑cked
));

56 
	sgdt_±r
 {

57 
	mlimô
;

58 
	mba£
;

59 } 
__©åibuã__
((
∑cked
));

65 
gdt_íåy
 
	ggdt
[
GDT
::
SIZE
];

66 
gdt_±r
 
	ggp
;

74 "C" 
gdt_Êush
();

81 
	gGDT
::
	$£t_g©e
(
num
,

82 
ba£
, 
limô
,

83 
ac˚ss
, 
gøn
) {

86 
gdt
[
num
].
ba£_low
 = (
ba£
 & 0xFFFF);

87 
gdt
[
num
].
ba£_middÀ
 = (
ba£
 >> 16) & 0xFF;

88 
gdt
[
num
].
ba£_high
 = (
ba£
 >> 24) & 0xFF;

91 
gdt
[
num
].
limô_low
 = (
limô
 & 0xFFFF);

92 
gdt
[
num
].
gønuœrôy
 = ((
limô
 >> 16) & 0x0F);

95 
gdt
[
num
].
gønuœrôy
 |(
gøn
 & 0xF0);

96 
gdt
[
num
].
ac˚ss
 =áccess;

97 
	}
}

101 
	gGDT
::
	$öô
() {

104 
gp
.
limô
 = ( (
gdt_íåy
Ë* 
SIZE
) - 1;

105 
gp
.
ba£
 = ()&
gdt
;

108 
	`£t_g©e
(0, 0, 0, 0, 0);

115 
	`£t_g©e
(1, 0, 0xFFFFFFFF, 0x9a, 0xCF);

120 
	`£t_g©e
(2, 0, 0xFFFFFFFF, 0x92, 0xCF);

123 
	`gdt_Êush
();

124 
	}
}

	@gdt.H

22 #i‚de‡
_GDT_H_


23 
	#_GDT_H_


	)

29 ˛as†
	cGDT
 {

31 
	m¥iv©e
:

34 
£t_g©e
(
num
,

35 
ba£
, 
limô
,

36 
ac˚ss
, 
gøn
);

38 
	mpublic
:

40 c⁄° 
SIZE
 = 3;

42 
öô
();

	@idt.C

27 
	~"utûs.H
"

28 
	~"idt.H
"

29 
	~"c⁄sﬁe.H
"

36 "C" 
idt_lﬂd
();

42 
	sidt_íåy


44 
	mba£_lo
;

45 
	m£l
;

46 
	mÆways0
;

47 
	mÊags
;

48 
	mba£_hi
;

49 } 
__©åibuã__
((
∑cked
));

51 
	sidt_±r


53 
	mlimô
;

54 
	mba£
;

55 } 
__©åibuã__
((
∑cked
));

68 
idt_íåy
 
	gidt
[
IDT
::
SIZE
];

69 
idt_±r
 
	gidç
;

76 
	gIDT
::
	$£t_g©e
(
num
, 
ba£
,

77 
£l
, 
Êags
) {

79 
C⁄sﬁe
::
	`puts
("Installing handler in IDTÖosition ");

80 
C⁄sﬁe
::
	`puti
(()
num
);

81 
C⁄sﬁe
::
	`puts
("\n");

84 
idt
[
num
].
ba£_lo
 = (
ba£
 & 0xFFFF);

85 
idt
[
num
].
ba£_hi
 = (
ba£
 >> 16) & 0xFFFF;

89 
idt
[
num
].
£l
 = sel;

90 
idt
[
num
].
Æways0
 = 0;

91 
idt
[
num
].
Êags
 = flags;

93 
	}
}

96 
	gIDT
::
	$öô
() {

99 
idç
.
limô
 = ( (
idt_íåy
) * 256) - 1;

100 
idç
.
ba£
 = ()&
idt
;

103 
	`mem£t
(&
idt
, 0, (
idt_íåy
) * 256);

107 
	`idt_lﬂd
();

108 
	}
}

	@idt.H

22 #i‚de‡
_IDT_H_


23 
	#_IDT_H_


	)

35 ˛as†
	cIDT
 {

37 
	mpublic
:

39 c⁄° 
SIZE
 = 256;

41 
öô
();

48 
£t_g©e
(
num
, 
ba£
,

49 
£l
, 
Êags
);

	@interrupts.C

21 
	~"as£π.H
"

22 
	~"utûs.H
"

23 
	~"c⁄sﬁe.H
"

24 
	~"idt.H
"

25 
	~"úq.H
"

26 
	~"ex˚±i⁄s.H
"

27 
	~"öãºu±s.H
"

42 "C" 
úq0
();

43 "C" 
úq1
();

44 "C" 
úq2
();

45 "C" 
úq3
();

46 "C" 
úq4
();

47 "C" 
úq5
();

48 "C" 
úq6
();

49 "C" 
úq7
();

50 "C" 
úq8
();

51 "C" 
úq9
();

52 "C" 
úq10
();

53 "C" 
úq11
();

54 "C" 
úq12
();

55 "C" 
úq13
();

56 "C" 
úq14
();

57 "C" 
úq15
();

59 "C" 
	$lowÀvñ_di•©ch_öãºu±
(
REGS
 * 
_r
) {

60 
I¡îru±H™dÀr
::
	`di•©ch_öãºu±
(
_r
);

61 
	}
}

67 
I¡îru±H™dÀr
 * I¡îru±H™dÀr::
h™dÀr_èbÀ
[I¡îru±H™dÀr::
IRQ_TABLE_SIZE
];

73 
	gI¡îru±H™dÀr
::
	$öô_di•©chî
() {

77 
IDT
::
	`£t_g©e
–0+ 
IRQ_BASE
, (Ë
úq0
, 0x08, 0x8E);

78 
IDT
::
	`£t_g©e
–1+ 
IRQ_BASE
, (Ë
úq1
, 0x08, 0x8E);

79 
IDT
::
	`£t_g©e
–2+ 
IRQ_BASE
, (Ë
úq2
, 0x08, 0x8E);

80 
IDT
::
	`£t_g©e
–3+ 
IRQ_BASE
, (Ë
úq3
, 0x08, 0x8E);

81 
IDT
::
	`£t_g©e
–4+ 
IRQ_BASE
, (Ë
úq4
, 0x08, 0x8E);

82 
IDT
::
	`£t_g©e
–5+ 
IRQ_BASE
, (Ë
úq5
, 0x08, 0x8E);

83 
IDT
::
	`£t_g©e
–6+ 
IRQ_BASE
, (Ë
úq6
, 0x08, 0x8E);

84 
IDT
::
	`£t_g©e
–7+ 
IRQ_BASE
, (Ë
úq7
, 0x08, 0x8E);

86 
IDT
::
	`£t_g©e
–8+ 
IRQ_BASE
, (Ë
úq8
, 0x08, 0x8E);

87 
IDT
::
	`£t_g©e
–9+ 
IRQ_BASE
, (Ë
úq9
, 0x08, 0x8E);

88 
IDT
::
	`£t_g©e
(10+ 
IRQ_BASE
, ()
úq10
, 0x08, 0x8E);

89 
IDT
::
	`£t_g©e
(11+ 
IRQ_BASE
, ()
úq11
, 0x08, 0x8E);

90 
IDT
::
	`£t_g©e
(12+ 
IRQ_BASE
, ()
úq12
, 0x08, 0x8E);

91 
IDT
::
	`£t_g©e
(13+ 
IRQ_BASE
, ()
úq13
, 0x08, 0x8E);

92 
IDT
::
	`£t_g©e
(14+ 
IRQ_BASE
, ()
úq14
, 0x08, 0x8E);

93 
IDT
::
	`£t_g©e
(15+ 
IRQ_BASE
, ()
úq15
, 0x08, 0x8E);

96 
i
;

97 
i
 = 0; i < 
IRQ_TABLE_SIZE
; i++) {

98 
h™dÀr_èbÀ
[
i
] = 
NULL
;

100 
	}
}

102 
BOOLEAN
 
	gI¡îru±H™dÀr
::
	$gíî©ed_by_¶ave_PIC
(
öt_no
) {

103  
öt_no
 > 7;

104 
	}
}

106 
	gI¡îru±H™dÀr
::
	$di•©ch_öãºu±
(
REGS
 * 
_r
) {

109 
öt_no
 = 
_r
->öt_nÿ- 
IRQ_BASE
;

115 
	`as£π
((
öt_no
 >0Ë&& (öt_nÿ< 
IRQ_TABLE_SIZE
));

119 
I¡îru±H™dÀr
 * 
h™dÀr
 = 
h™dÀr_èbÀ
[
öt_no
];

121 i‡(!
h™dÀr
) {

123 
C⁄sﬁe
::
	`puts
("INTERRUPT NO: ");

124 
C⁄sﬁe
::
	`puti
(
öt_no
);

125 
C⁄sﬁe
::
	`puts
("\n");

126 
C⁄sﬁe
::
	`puts
("NO DEFAULT INTERRUPT HANDLER REGISTERED\n");

131 
h™dÀr
->
	`h™dÀ_öãºu±
(
_r
);

141 i‡(
	`gíî©ed_by_¶ave_PIC
(
öt_no
)) {

142 
	`ouç‹tb
(0xA0, 0x20);

146 
	`ouç‹tb
(0x20, 0x20);

148 
	}
}

150 
	gI¡îru±H™dÀr
::
	$ªgi°î_h™dÀr
(
_úq_code
,

151 
I¡îru±H™dÀr
 * 
_h™dÀr
) {

152 
	`as£π
(
_úq_code
 >0 && _úq_codê< 
IRQ_TABLE_SIZE
);

154 
h™dÀr_èbÀ
[
_úq_code
] = 
_h™dÀr
;

156 
C⁄sﬁe
::
	`puts
("Installed interrupt handlerát IRQ ");

157 
C⁄sﬁe
::
	`putui
(
_úq_code
);

158 
C⁄sﬁe
::
	`puts
("\n");

160 
	}
}

162 
	gI¡îru±H™dÀr
::
	$dîegi°î_h™dÀr
(
_úq_code
) {

164 
	`as£π
(
_úq_code
 >0 && _úq_codê< 
IRQ_TABLE_SIZE
);

166 
h™dÀr_èbÀ
[
_úq_code
] = 
NULL
;

168 
C⁄sﬁe
::
	`puts
("UNINSTALLED interrupt handlerát IRQ ");

169 
C⁄sﬁe
::
	`putui
(
_úq_code
);

170 
C⁄sﬁe
::
	`puts
("\n");

172 
	}
}

	@interrupts.H

13 #i‚de‡
_öãºu±s_H_


14 
	#_öãºu±s_H_


	)

20 
	~"utûs.H
"

21 
	~"as£π.H
"

22 
	~"machöe.H
"

23 
	~"ex˚±i⁄s.H
"

29 ˛as†
	cI¡îru±H™dÀr
 {

31 
	m¥iv©e
:

34 c⁄° 
IRQ_TABLE_SIZE
 = 16;

35 c⁄° 
	mIRQ_BASE
 = 32;

37 
I¡îru±H™dÀr
 * 
	mh™dÀr_èbÀ
[
IRQ_TABLE_SIZE
];

39 
BOOLEAN
 
gíî©ed_by_¶ave_PIC
(
öt_no
);

42 
	mpublic
:

45 
ªgi°î_h™dÀr
(
_úq_code
,

46 
I¡îru±H™dÀr
 * 
_h™dÀr
);

53 
dîegi°î_h™dÀr
(
_úq_code
);

56 
öô_di•©chî
();

62 
di•©ch_öãºu±
(
REGS
 * 
_r
);

70 
vútuÆ
 
	$h™dÀ_öãºu±
(
REGS
 * 
_ªgs
) {

71 
	`as£π
(
FALSE
);

77 
	}
};

	@irq.C

17 
	#IRQ_BASE
 32

	)

23 
	~"utûs.H
"

24 
	~"úq.H
"

36 
	$úq_ªm≠
()

38 
	`ouç‹tb
(0x20, 0x11);

39 
	`ouç‹tb
(0xA0, 0x11);

40 
	`ouç‹tb
(0x21, 0x20);

41 
	`ouç‹tb
(0xA1, 0x28);

42 
	`ouç‹tb
(0x21, 0x04);

43 
	`ouç‹tb
(0xA1, 0x02);

44 
	`ouç‹tb
(0x21, 0x01);

45 
	`ouç‹tb
(0xA1, 0x01);

46 
	`ouç‹tb
(0x21, 0x0);

47 
	`ouç‹tb
(0xA1, 0x0);

48 
	}
}

55 
	gIRQ
::
	$öô
() {

57 
	`úq_ªm≠
();

60 
	}
}

	@irq.H

17 #i‚de‡
_IRQ_H_


18 
	#_IRQ_H_


	)

25 ˛as†
	cIRQ
 {

27 
	mpublic
:

29 
öô
();

	@kernel.C

23 
	#_USES_SCHEDULER_


	)

30 
	#_USES_DISK_


	)

36 
	#_USES_FILESYSTEM_


	)

47 
	~"machöe.H
"

48 
	~"c⁄sﬁe.H
"

49 
	~"gdt.H
"

50 
	~"idt.H
"

51 
	~"úq.H
"

52 
	~"ex˚±i⁄s.H
"

53 
	~"öãºu±s.H
"

55 
	~"sim∂e_timî.H
"

57 
	~"‰ame_poﬁ.H
"

58 
	~"mem_poﬁ.H
"

60 
	~"thªad.H
"

62 #ifde‡
_USES_SCHEDULER_


63 
	~"ScheduÀr.H
"

66 #ifde‡
_USES_DISK_


67 
	~"sim∂e_disk.H
"

68 
	~"blockög_disk.H
"

71 #ifde‡
_USES_FILESYSTEM_


72 
	~"fûe_sy°em.H
"

80 
FømePoﬁ
 * 
	gSYSTEM_FRAME_POOL
;

83 
MemPoﬁ
 * 
	gMEMORY_POOL
;

89 #ifde‡
_USES_SCHEDULER_


92 
ScheduÀr
 * 
	gSYSTEM_SCHEDULER
;

100 #ifde‡
_USES_DISK_


104 
Sim∂eDisk
 * 
	gSYSTEM_DISK
;

106 
	#SYSTEM_DISK_SIZE
 10485760

	)

114 #ifde‡
_USES_FILESYSTEM_


117 
FûeSy°em
 * 
	gFILE_SYSTEM
;

125 
	$∑ss_⁄_CPU
(
Thªad
 * 
_to_thªad
) {

127 #i‚de‡
_USES_SCHEDULER_


131 
Thªad
::
	`di•©ch_to
(
_to_thªad
);

139 
SYSTEM_SCHEDULER
->
	`ªsume
(
Thªad
::
	`CuºítThªad
());

140 
SYSTEM_SCHEDULER
->
	`yõld
();

142 
	}
}

149 #ifde‡
_USES_FILESYSTEM_


151 
	$ønd
() {

154 
dummy_£c
;

155 
dummy_tic
;

159  
dummy_tic
;

160 
	}
}

162 
	$exîci£_fûe_sy°em
(
FûeSy°em
 * 
_fûe_sy°em
, 
Sim∂eDisk
 * 
_sim∂e_disk
) {

165 
C⁄sﬁe
::
	`puts
("Initializing file system\n");

166 
FûeSy°em
 *
fs
 = 
_fûe_sy°em
;

167 
Sim∂eDisk
 *
disk
 = 
_sim∂e_disk
;

169 
ãmp_buf„r
[205];

170 
buf1
[500];

171 
wrôãn_ch¨
;

172 
ãmp_buf„r
[0] = 'A';

173 
ãmp_buf„r
[1] = 'r';

174 
ãmp_buf„r
[2] = 'J';

175 
ãmp_buf„r
[3] = 'U';

176 
i
 = 4; i < 200; i++)

177 
ãmp_buf„r
[
i
] = '*';

179 
fs_size
 = 
BLOCK_SIZE
 * 1000;

180 i‡(
fs
->
	`Mou¡
(
disk
Ë=
TRUE
)

182 
C⁄sﬁe
::
	`puts
("Mount successful\n");

186 
C⁄sﬁe
::
	`puts
("Mount unsuccessful\n");

190 i‡(
fs
->
	`F‹m©
(
disk
, 
fs_size
Ë=
TRUE
)

192 
C⁄sﬁe
::
	`puts
("Format successful\n");

196 
C⁄sﬁe
::
	`puts
("Format unsuccessful\n");

200 if(
fs
->
	`Cª©eFûe
(1Ë=
TRUE
)

202 
C⁄sﬁe
::
	`puts
("File 1 created successfully\n");

205 
Fûe
 
f1
 = 
	`Fûe
();

206 if(
fs
->
	`LookupFûe
(1, &
f1
Ë=
TRUE
)

208 
C⁄sﬁe
::
	`puts
("FileÜookup for file 1 successful\n");

212 
C⁄sﬁe
::
	`puts
("FileÜookup for file 1 failed\n");

214 
C⁄sﬁe
::
	`puts
("GoingÅo write\n");

215 
wrôãn_ch¨
 = 
f1
.
	`Wrôe
(100, 
ãmp_buf„r
);

217 
C⁄sﬁe
::
	`puts
("Wrote ");

218 
C⁄sﬁe
::
	`puti
(
wrôãn_ch¨
);

219 
C⁄sﬁe
::
	`puts
(" characters intoÅhe disk\n");

221 
ªad_ch¨
 = 
f1
.
	`Ród
(300, 
buf1
);

222 
C⁄sﬁe
::
	`puts
("Read ");

223 
C⁄sﬁe
::
	`puti
(
ªad_ch¨
);

224 
C⁄sﬁe
::
	`puts
(" characters\n");

225 
C⁄sﬁe
::
	`puts
("...Read data = ");

226 
i
 = 0; i < 100; i++)

228 
C⁄sﬁe
::
	`putch
(
buf1
[
i
]);

231 
ãmp_buf„r
[0] = 'C';

232 
f1
.
	`Wrôe
(100, 
ãmp_buf„r
);

234 
C⁄sﬁe
::
	`puts
("\nResetting currentÖositionÅoÅhe start of file\n");

235 
f1
.
	`Re£t
();

237 
ªad_ch¨
 = 
f1
.
	`Ród
(300, 
buf1
);

238 
C⁄sﬁe
::
	`puts
("\nRead ");

239 
C⁄sﬁe
::
	`puti
(
ªad_ch¨
);

240 
C⁄sﬁe
::
	`puts
(" characters\n");

241 
C⁄sﬁe
::
	`puts
("...Read data = ");

242 
i
 = 0; i < 200; i++)

244 
C⁄sﬁe
::
	`putch
(
buf1
[
i
]);

249 
	}
}

257 
Thªad
 * 
	gthªad1
;

258 
Thªad
 * 
	gthªad2
;

259 
Thªad
 * 
	gthªad3
;

260 
Thªad
 * 
	gthªad4
;

262 
	$fun1
() {

263 
C⁄sﬁe
::
	`puts
("THREAD: "); C⁄sﬁe::
	`puti
(
Thªad
::
	`CuºítThªad
()->
	`ThªadId
()); Console::puts("\n");

265 
C⁄sﬁe
::
	`puts
("FUN 1 INVOKED!\n");

267 
j
 = 0;; j++) {

269 
C⁄sﬁe
::
	`puts
("FUN 1 IN ITERATION["); C⁄sﬁe::
	`puti
(
j
); Console::puts("]\n");

271 
i
 = 0; i < 10; i++) {

272 
C⁄sﬁe
::
	`puts
("FUN 1: TICK ["); C⁄sﬁe::
	`puti
(
i
); Console::puts("]\n");

275 
	`∑ss_⁄_CPU
(
thªad2
);

277 
	}
}

281 
	$fun2
() {

282 
C⁄sﬁe
::
	`puts
("THREAD: "); C⁄sﬁe::
	`puti
(
Thªad
::
	`CuºítThªad
()->
	`ThªadId
()); Console::puts("\n");

284 
C⁄sﬁe
::
	`puts
("FUN 2 INVOKED!\n");

286 #ifde‡
_USES_DISK_


287 
buf
[512];

288 
ªad_block
 = 1;

289 
wrôe_block
 = 0;

292 
j
 = 0;; j++) {

294 
C⁄sﬁe
::
	`puts
("FUN 2 IN ITERATION["); C⁄sﬁe::
	`puti
(
j
); Console::puts("]\n");

296 #ifde‡
_USES_DISK_


298 
C⁄sﬁe
::
	`puts
("Readingá block from disk...\n");

300 
SYSTEM_DISK
->
	`ªad
(
ªad_block
, 
buf
);

303 
i
;

304 
C⁄sﬁe
::
	`puts
("Read data = ");

305 
i
 = 0; i < 512; i++) {

306 
C⁄sﬁe
::
	`putch
(
buf
[
i
]);

308 
C⁄sﬁe
::
	`puts
("\n");

310 
k
 = 0; k < 512; k++)

312 
buf
[
k
] = 'A' + k % 20;

314 #i‚de‡
_USES_FILESYSTEM_


319 
C⁄sﬁe
::
	`puts
("Writingá blockÅo disk...\n");

321 
SYSTEM_DISK
->
	`wrôe
(
wrôe_block
, 
buf
);

325 
wrôe_block
 = 
ªad_block
;

326 
ªad_block
 = (read_block + 1) % 10;

329 
i
 = 0; i < 10; i++) {

330 
C⁄sﬁe
::
	`puts
("FUN 2: TICK ["); C⁄sﬁe::
	`puti
(
i
); Console::puts("]\n");

336 
	`∑ss_⁄_CPU
(
thªad3
);

338 
	}
}

340 
	$fun3
() {

341 
C⁄sﬁe
::
	`puts
("THREAD: "); C⁄sﬁe::
	`puti
(
Thªad
::
	`CuºítThªad
()->
	`ThªadId
()); Console::puts("\n");

343 
C⁄sﬁe
::
	`puts
("FUN 3 INVOKED!\n");

345 #ifde‡
_USES_FILESYSTEM_


347 
	`exîci£_fûe_sy°em
(
FILE_SYSTEM
, 
SYSTEM_DISK
);

351 
j
 = 0;; j++) {

353 
C⁄sﬁe
::
	`puts
("FUN 3 IN BURST["); C⁄sﬁe::
	`puti
(
j
); Console::puts("]\n");

355 
i
 = 0; i < 10; i++) {

356 
C⁄sﬁe
::
	`puts
("FUN 3: TICK ["); C⁄sﬁe::
	`puti
(
i
); Console::puts("]\n");

360 
	`∑ss_⁄_CPU
(
thªad4
);

362 
	}
}

364 
	$fun4
() {

365 
C⁄sﬁe
::
	`puts
("THREAD: "); C⁄sﬁe::
	`puti
(
Thªad
::
	`CuºítThªad
()->
	`ThªadId
()); Console::puts("\n");

367 
j
 = 0;; j++) {

369 
C⁄sﬁe
::
	`puts
("FUN 4 IN BURST["); C⁄sﬁe::
	`puti
(
j
); Console::puts("]\n");

371 
i
 = 0; i < 10; i++) {

372 
C⁄sﬁe
::
	`puts
("FUN 4: TICK ["); C⁄sﬁe::
	`puti
(
i
); Console::puts("]\n");

375 
	`∑ss_⁄_CPU
(
thªad1
);

377 
	}
}

383 #ifde‡
MSDOS


384 
	tsize_t
;

386 
	tsize_t
;

390 * 
›î©‹
 
	$√w
 (
size_t
 
size
) {

391 
a
 = 
MEMORY_POOL
->
	`Æloˇã
(()
size
);

392  (*)
a
;

393 
	}
}

396 * 
›î©‹
 
	g√w
[] (
size_t
 
	gsize
) {

397 
	ga
 = 
MEMORY_POOL
->
Æloˇã
(()
size
);

398  (*)
	ga
;

402 
›î©‹
 
	$dñëe
 (* 
p
) {

403 
MEMORY_POOL
->
	`ªÀa£
(()
p
);

404 
	}
}

407 
›î©‹
 
	gdñëe
[] (* 
	gp
) {

408 
	gMEMORY_POOL
->
ªÀa£
(()
p
);

415 
	$maö
() {

417 
GDT
::
	`öô
();

418 
C⁄sﬁe
::
	`öô
();

419 
IDT
::
	`öô
();

420 
Ex˚±i⁄H™dÀr
::
	`öô_di•©chî
();

421 
IRQ
::
	`öô
();

422 
I¡îru±H™dÀr
::
	`öô_di•©chî
();

426 ˛as†
	cDBZ_H™dÀr
 : 
public
 
Ex˚±i⁄H™dÀr
 {

427 
public
:

428 
vútuÆ
 
	`h™dÀ_ex˚±i⁄
(
REGS
 * 
_ªgs
) {

429 
C⁄sﬁe
::
	`puts
("DIVISION BY ZERO!\n");

432 
	}
} 
	gdbz_h™dÀr
;

434 
	gEx˚±i⁄H™dÀr
::
ªgi°î_h™dÀr
(0, &
dbz_h™dÀr
);

442 
FømePoﬁ
 
	gsy°em_‰ame_poﬁ
;

443 
	gSYSTEM_FRAME_POOL
 = &
sy°em_‰ame_poﬁ
;

446 
MemPoﬁ
 
mem‹y_poﬁ
(
SYSTEM_FRAME_POOL
, 256);

447 
	gMEMORY_POOL
 = &
mem‹y_poﬁ
;

455 
Sim∂eTimî
 
timî
(100);

456 
	gI¡îru±H™dÀr
::
ªgi°î_h™dÀr
(0, &
timî
);

459 #ifde‡
_USES_SCHEDULER_


463 
ScheduÀr
 
	gsy°em_scheduÀr
 = Scheduler();

464 
	gSYSTEM_SCHEDULER
 = &
sy°em_scheduÀr
;

468 #ifde‡
_USES_DISK_


473 
Sim∂eDisk
 
	gsy°em_disk
 = Sim∂eDisk(
MASTER
, 
SYSTEM_DISK_SIZE
);

474 
	gSYSTEM_DISK
 = &
sy°em_disk
;

478 #ifde‡
_USES_FILESYSTEM_


482 
FûeSy°em
 
	gfûe_sy°em
 = FileSystem();

483 
	gFILE_SYSTEM
 = &
fûe_sy°em
;

495 
machöe_íabÀ_öãºu±s
();

499 
	gC⁄sﬁe
::
puts
("Hello World!\n");

503 
	gC⁄sﬁe
::
puts
("CREATING THREAD 1...\n");

504 * 
	g°ack1
 = 
√w
 [1024];

505 
	gthªad1
 = 
√w
 
Thªad
(
fun1
, 
°ack1
, 1024);

506 
	gC⁄sﬁe
::
puts
("DONE\n");

508 
	gC⁄sﬁe
::
puts
("CREATING THREAD 2...");

509 * 
	g°ack2
 = 
√w
 [1024];

510 
	gthªad2
 = 
√w
 
Thªad
(
fun2
, 
°ack2
, 1024);

511 
	gC⁄sﬁe
::
puts
("DONE\n");

513 
	gC⁄sﬁe
::
puts
("CREATING THREAD 3...");

514 * 
	g°ack3
 = 
√w
 [1024];

515 
	gthªad3
 = 
√w
 
Thªad
(
fun3
, 
°ack3
, 1024);

516 
	gC⁄sﬁe
::
puts
("DONE\n");

518 
	gC⁄sﬁe
::
puts
("CREATING THREAD 4...");

519 * 
	g°ack4
 = 
√w
 [1024];

520 
	gthªad4
 = 
√w
 
Thªad
(
fun4
, 
°ack4
, 1024);

521 
	gC⁄sﬁe
::
puts
("DONE\n");

523 #ifde‡
_USES_SCHEDULER_


527 
	gSYSTEM_SCHEDULER
->
add
(
thªad2
);

528 
	gSYSTEM_SCHEDULER
->
add
(
thªad3
);

529 
	gSYSTEM_SCHEDULER
->
add
(
thªad4
);

535 
	gC⁄sﬁe
::
puts
("STARTING THREAD 1 ...\n");

536 
	gThªad
::
di•©ch_to
(
thªad1
);

540 
as£π
(
FALSE
);

	@machine.C

17 
	~"machöe.H
"

19 
	~"as£π.H
"

21 
	~"thªads_low.H
"

27 
	$machöe_öãºu±s_íabÀd
() {

29  
	`gë_EFLAGS
() & (1 << 9);

30 
	}
}

32 
	$machöe_íabÀ_öãºu±s
() {

33 
	`as£π
(!
	`machöe_öãºu±s_íabÀd
());

34 
__asm__
 
	`__vﬁ©ûe__
 ("sti");

35 
	}
}

37 
	$machöe_dißbÀ_öãºu±s
() {

38 
	`as£π
(
	`machöe_öãºu±s_íabÀd
());

39 
__asm__
 
	`__vﬁ©ûe__
 ("cli");

40 
	}
}

	@machine.H

13 #i‚de‡
_machöe_H_


14 
	#_machöe_H_


	)

22 
	#KERNEL_DS
 0x10

	)

23 
	#KERNEL_CS
 0x08

	)

28 
	#PAGE_SIZE
 4096

	)

29 
	#PT_ENTRIES_PER_PAGE
 1024

	)

44 
	sªgs
 {

47 
	mgs
;

48 
	mfs
;

49 
	mes
;

50 
	mds
;

53 
	medi
;

54 
	mesi
;

55 
	mebp
;

56 
	me•
;

57 
	mebx
;

58 
	medx
;

59 
	mecx
;

60 
	móx
;

65 
	möt_no
;

66 
	mîr_code
;

70 
	meù
;

71 
	mcs
;

72 
	meÊags
;

78 
	mu£ª•
;

79 
	mss
;

80 } 
	tREGS
;

93 
machöe_öãºu±s_íabÀd
();

96 
machöe_íabÀ_öãºu±s
();

97 
machöe_dißbÀ_öãºu±s
();

	@mem_pool.C

21 
	~"utûs.H
"

22 
	~"c⁄sﬁe.H
"

24 
	~"mem_poﬁ.H
"

30 
	gMemPoﬁ
::
	$MemPoﬁ
(
FømePoﬁ
 * 
_‰ame_poﬁ
, 
_n_‰ames
) {

31 
C⁄sﬁe
::
	`puts
("Allocating Memory Pool... ");

32 
°¨t_addªss
 = 
_‰ame_poﬁ
->
	`gë_‰ame
();

33 
i
 = 1; i < 
_n_‰ames
; i++) {

34 
√xt_‰ame_addr
 = 
_‰ame_poﬁ
->
	`gë_‰ame
();

36 
C⁄sﬁe
::
	`puts
("done\n");

37 
	}
}

40 
	gMemPoﬁ
::
	$Æloˇã
(
_size
) {

42 
ªtu∫_addªss
 = 
°¨t_addªss
;

43 
°¨t_addªss
 +
_size
;

45  
ªtu∫_addªss
;

47 
	}
}

50 
	gMemPoﬁ
::
	$ªÀa£
(
_°¨t_addªss
) {

52 
	}
}

	@mem_pool.H

17 #i‚de‡
_MEM_POOL_H_


18 
	#_MEM_POOL_H_


	)

30 
	~"utûs.H
"

31 
	~"‰ame_poﬁ.H
"

43 ˛as†
	cMemPoﬁ
 {

45 
	m¥iv©e
:

46 
°¨t_addªss
;

48 
	mpublic
:

49 
MemPoﬁ
(
FømePoﬁ
 * 
_‰ame_poﬁ
, 
_n_‰ames
);

52 
Æloˇã
(
_size
);

57 
ªÀa£
(
_°¨t_addªss
);

	@simple_disk.C

26 
	~"as£π.H
"

27 
	~"utûs.H
"

28 
	~"c⁄sﬁe.H
"

29 
	~"sim∂e_disk.H
"

35 
	gSim∂eDisk
::
	$Sim∂eDisk
(
DISK_ID
 
_disk_id
, 
_size
) {

36 
disk_id
 = 
_disk_id
;

37 
disk_size
 = 
_size
;

38 
	}
}

44 
	gSim∂eDisk
::
	$size
() {

45  
disk_size
;

46 
	}
}

52 
	gSim∂eDisk
::
	$issue_›î©i⁄
(
DISK_OPERATION
 
_›
, 
_block_no
) {

54 
	`ouç‹tb
(0x1F1, 0x00);

55 
	`ouç‹tb
(0x1F2, 0x01);

56 
	`ouç‹tb
(0x1F3, ()
_block_no
);

58 
	`ouç‹tb
(0x1F4, ()(
_block_no
 >> 8));

60 
	`ouç‹tb
(0x1F5, ()(
_block_no
 >> 16));

62 
	`ouç‹tb
(0x1F6, (()(
_block_no
 >> 24)&0x0FË| 0xE0 | (
disk_id
 << 4));

66 
	`ouç‹tb
(0x1F7, (
_›
 =
READ
) ? 0x20 : 0x30);

68 
	}
}

70 
BOOLEAN
 
	gSim∂eDisk
::
	$is_ªady
() {

71  (
	`öp‹tb
(0x1F7) & 0x08);

72 
	}
}

74 
	gSim∂eDisk
::
	$ªad
(
_block_no
, * 
_buf
) {

78 
	`issue_›î©i⁄
(
READ
, 
_block_no
);

80 
	`waô_u¡û_ªady
();

83 
i
;

84 
tmpw
;

85 
i
 = 0; i < 256; i++) {

86 
tmpw
 = 
	`öp‹tw
(0x1F0);

87 
_buf
[
i
*2] = ()
tmpw
;

88 
_buf
[
i
*2+1] = ()(
tmpw
 >> 8);

90 
	}
}

92 
	gSim∂eDisk
::
	$wrôe
(
_block_no
, * 
_buf
) {

95 
	`issue_›î©i⁄
(
WRITE
, 
_block_no
);

97 
	`waô_u¡û_ªady
();

100 
i
;

101 
tmpw
;

102 
i
 = 0; i < 256; i++) {

103 
tmpw
 = 
_buf
[2*
i
] | (_buf[2*i+1] << 8);

104 
	`ouç‹tw
(0x1F0, 
tmpw
);

107 
	}
}

	@simple_disk.H

16 #i‚de‡
_SIMPLE_DISK_H_


17 
	#_SIMPLE_DISK_H_


	)

28 
	~"utûs.H
"

35 íum {
	mMASTER
 = 0, 
	mSLAVE
 = 1} 
	tDISK_ID
;

36 íum {
	mREAD
 = 0, 
	mWRITE
 = 1} 
	tDISK_OPERATION
;

43 ˛as†
	cSim∂eDisk
 {

44 
	m¥iv©e
:

47 
DISK_ID
 
disk_id
;

49 
	mdisk_size
;

53 
	m¥Ÿe˘ed
:

56 
issue_›î©i⁄
(
DISK_OPERATION
 
_›
, 
_block_no
);

60 
vútuÆ
 
BOOLEAN
 
is_ªady
();

63 
vútuÆ
 
	$waô_u¡û_ªady
() {

64 !
	`is_ªady
()) { ; }

72 
public
:

74 
	`Sim∂eDisk
(
DISK_ID
 
_disk_id
, 
_size
);

82 
vútuÆ
 
	`size
();

88 
vútuÆ
 
	`ªad
(
_block_no
, * 
_buf
);

92 
vútuÆ
 
	`wrôe
(
_block_no
, * 
_buf
);

95 
	}
};

	@simple_timer.C

22 
	~"as£π.H
"

23 
	~"utûs.H
"

24 
	~"c⁄sﬁe.H
"

25 
	~"öãºu±s.H
"

26 
	~"sim∂e_timî.H
"

32 
	gSim∂eTimî
::
	$Sim∂eTimî
(
_hz
) {

34 
£c⁄ds
 = 0;

35 
ticks
 = 0;

42 
	`£t_‰equícy
(
_hz
);

44 
	}
}

51 
	gSim∂eTimî
::
	$h™dÀ_öãºu±
(
REGS
 *
_r
) {

58 
ticks
++;

61 i‡(
ticks
 >
hz
 )

63 
£c⁄ds
++;

64 
ticks
 = 0;

65 
C⁄sﬁe
::
	`puts
("One second hasÖassed\n");

67 
	}
}

70 
	gSim∂eTimî
::
	$£t_‰equícy
(
_hz
) {

74 
hz
 = 
_hz
;

75 
divis‹
 = 1193180 / 
_hz
;

76 
	`ouç‹tb
(0x43, 0x34);

77 
	`ouç‹tb
(0x40, 
divis‹
 & 0xFF);

78 
	`ouç‹tb
(0x40, 
divis‹
 >> 8);

79 
	}
}

81 
	gSim∂eTimî
::
	$cuºít
(* 
_£c⁄ds
, * 
_ticks
) {

84 *
_£c⁄ds
 = 
£c⁄ds
;

85 *
_ticks
 = 
ticks
;

86 
	}
}

88 
	gSim∂eTimî
::
	$waô
(
_£c⁄ds
) {

91 
now_£c⁄ds
;

92 
now_ticks
;

93 
	`cuºít
(&
now_£c⁄ds
, &
now_ticks
);

95 
thí_£c⁄ds
 = 
now_£c⁄ds
 + 
_£c⁄ds
;

97 (
£c⁄ds
 <
thí_£c⁄ds
Ë&& (
ticks
 < 
now_ticks
));

98 
	}
}

	@simple_timer.H

11 #i‚de‡
_SIMPLE_TIMER_H_


12 
	#_SIMPLE_TIMER_H_


	)

24 
	~"öãºu±s.H
"

30 ˛as†
	cSim∂eTimî
 : 
public
 
I¡îru±H™dÀr
 {

32 
¥iv©e
:

35 
£c⁄ds
;

36 
	mticks
;

39 
	mhz
;

43 
£t_‰equícy
(
_hz
);

46 
	mpublic
 :

48 
Sim∂eTimî
(
_hz
);

51 
vútuÆ
 
h™dÀ_öãºu±
(
REGS
 *
_r
);

56 
cuºít
(* 
_£c⁄ds
, * 
_ticks
);

59 
waô
(
_£c⁄ds
);

	@thread.C

31 
	~"as£π.H
"

32 
	~"utûs.H
"

33 
	~"c⁄sﬁe.H
"

35 
	~"‰ame_poﬁ.H
"

37 
	~"thªad.H
"

39 
	~"thªads_low.H
"

45 
Thªad
 * 
	gcuºít_thªad
 = 0;

53 
	gThªad
::
√xtFªePid
;

62 
ölöe
 
	gThªad
::
	$push
(
_vÆ
) {

64 
e•
 -= 4;

65 *((*Ë
e•
Ë
_vÆ
;

66 
	}
}

71 
	$thªad_shutdown
() {

77 
	`as£π
(
FALSE
);

81 
	}
}

83 
	$thªad_°¨t
() {

87 
	}
}

89 
	gThªad
::
	$£tup_c⁄ãxt
(
Thªad_Fun˘i⁄
 
_tfun˘i⁄
){

102 
	`push
(0);

105 
	`push
((Ë&
thªad_shutdown
);

110 
	`push
((Ë
_tfun˘i⁄
);

120 
	`push
(0);

124 
	`push
(
KERNEL_CS
);

125 
	`push
((Ë&
thªad_°¨t
);

130 
	`push
(0);

131 
	`push
(0);

134 
	`push
(0);

135 
	`push
(0);

136 
	`push
(0);

137 
	`push
(0);

138 
	`push
(0);

139 
	`push
(0);

140 
	`push
(0);

141 
	`push
(0);

149 
	`push
(
KERNEL_DS
);

150 
	`push
(
KERNEL_DS
);

151 
	`push
(0);

152 
	`push
(0);

154 
C⁄sﬁe
::
	`puts
("e• = "); C⁄sﬁe::
	`putui
(()
e•
); Console::puts("\n");

156 
C⁄sﬁe
::
	`puts
("done\n");

157 
	}
}

163 
	gThªad
::
	$Thªad
(
Thªad_Fun˘i⁄
 
_tf
, * 
_°ack
, 
_°ack_size
) {

172 
thªad_id
 = 
√xtFªePid
++;

176 
e•
 = (*)(()
_°ack
 + 
_°ack_size
);

179 
°ack
 = 
_°ack
;

180 
°ack_size
 = 
_°ack_size
;

184 
	`£tup_c⁄ãxt
(
_tf
);

186 
	}
}

188 
	gThªad
::
	$ThªadId
() {

189  
thªad_id
;

190 
	}
}

192 
	gThªad
::
	$di•©ch_to
(
Thªad
 * 
_thªad
) {

203 
	`thªads_low_swôch_to
(
_thªad
);

206 
	}
}

209 
Thªad
 * 
	gThªad
::
	$CuºítThªad
() {

211  
cuºít_thªad
;

212 
	}
}

	@thread.H

17 #i‚de‡
_thªad_H_


18 
	#_thªad_H_


	)

30 
	~"machöe.H
"

37 (*
	gThªad_Fun˘i⁄
)();

43 ˛as†
	cThªad
 {

45 
	m¥iv©e
:

46 * 
e•
;

49 
	mthªad_id
;

50 * 
	m°ack
;

51 
	m°ack_size
;

52 
	m¥i‹ôy
;

53 * 
	mˇrgo
;

57 
	m√xtFªePid
;

59 
push
(
_vÆ
);

62 
£tup_c⁄ãxt
(
Thªad_Fun˘i⁄
 
_tfun˘i⁄
);

67 
	mpublic
:

68 
Thªad
(
Thªad_Fun˘i⁄
 
_tf
, * 
_°ack
, 
_°ack_size
);

74 
ThªadId
();

77 
di•©ch_to
(
Thªad
 * 
_thªad
);

84 
Thªad
 * 
CuºítThªad
();

	@threads_low.H

14 #i‚de‡
_thªads_low_H_


15 
	#_thªads_low_H_


	)

21 
	~"thªad.H
"

31 "C" 
thªads_low_swôch_to
(
Thªad
 * 
_thªad
);

36 "C" 
gë_EFLAGS
();

	@utils.C

30 
	~"utûs.H
"

48 
	$ab‹t
() {

50 
	}
}

56 *
	$mem˝y
(*
de°
, c⁄° *
§c
, 
cou¡
)

58 c⁄° *
•
 = (c⁄° *)
§c
;

59 *
dp
 = (*)
de°
;

60 ; 
cou¡
 !0; cou¡--Ë*
dp
++ = *
•
++;

61  
de°
;

62 
	}
}

64 *
	$mem£t
(*
de°
, 
vÆ
, 
cou¡
)

66 *
ãmp
 = (*)
de°
;

67  ; 
cou¡
 !0; cou¡--Ë*
ãmp
++ = 
vÆ
;

68  
de°
;

69 
	}
}

71 *
	$mem£tw
(*
de°
, 
vÆ
, 
cou¡
)

73 *
ãmp
 = (*)
de°
;

74  ; 
cou¡
 !0; cou¡--Ë*
ãmp
++ = 
vÆ
;

75  
de°
;

76 
	}
}

83 
	$°æí
(c⁄° *
_°r
) {

87 
Àn
 = 0;

88 *
_°r
 != 0) {

89 
_°r
++;

90 
Àn
++;

92  
Àn
;

93 
	}
}

94 
	$°r˝y
(* 
_d°
, * 
_§c
) {

95 *
_§c
 != 0) {

96 *
_d°
 = *
_§c
;

97 
_d°
++;

98 
_§c
++;

100 *
_d°
 = 0;

101 
	}
}

103 
	$öt2°r
(
_num
, * 
_°r
) {

105 
i
;

106 
ãmp
[11];

108 
ãmp
[0] = '\0';

109 
i
 = 1; i <= 10; i++) {

110 
ãmp
[
i
] = 
_num
 % 10 + '0';

111 
_num
 /= 10;

113 
i
 = 10; 
ãmp
[i] == '0'; i--);

114 if–
i
 == 0 )

115 
i
++;

116  
i
 >= 0 )

117 *
_°r
++ = 
ãmp
[
i
--];

118 
	}
}

121 
	$uöt2°r
(
_num
, * 
_°r
) {

123 
i
;

124 
ãmp
[11];

126 
ãmp
[0] = '\0';

127 
i
 = 1; i <= 10; i++) {

128 
ãmp
[
i
] = 
_num
 % 10 + '0';

129 
_num
 /= 10;

131 
i
 = 10; 
ãmp
[i] == '0'; i--);

132 if–
i
 == 0 )

133 
i
++;

134  
i
 >= 0 )

135 *
_°r
++ = 
ãmp
[
i
--];

136 
	}
}

145 
	$öp‹tb
 (
_p‹t
) {

146 
rv
;

147 
__asm__
 
	`__vﬁ©ûe__
 ("öb %1, %0" : "˜" (
rv
Ë: "dN" (
_p‹t
));

148  
rv
;

149 
	}
}

151 
	$öp‹tw
 (
_p‹t
) {

152 
rv
;

153 
__asm__
 
	`__vﬁ©ûe__
 ("öw %1, %0" : "˜" (
rv
Ë: "dN" (
_p‹t
));

154  
rv
;

155 
	}
}

161 
	$ouç‹tb
 (
_p‹t
, 
_d©a
) {

162 
__asm__
 
	`__vﬁ©ûe__
 ("outb %1, %0" : : "dN" (
_p‹t
), "a" (
_d©a
));

163 
	}
}

165 
	$ouç‹tw
 (
_p‹t
, 
_d©a
) {

166 
__asm__
 
	`__vﬁ©ûe__
 ("outw %1, %0" : : "dN" (
_p‹t
), "a" (
_d©a
));

167 
	}
}

	@utils.H

12 #i‚de‡
_utûs_h_


13 
	#_utûs_h_


	)

19 #i‚de‡
NULL


20 
	#NULL
 0

	)

23 #ifde‡
BOOLEAN


24 #unde‡
BOOLEAN


26 
	#BOOLEAN
 

	)

28 #i‚de‡
TRUE


29 
	#TRUE
 1

	)

32 #i‚de‡
FALSE


33 
	#FALSE
 0

	)

40 
ab‹t
();

47 *
mem˝y
(*
de°
, c⁄° *
§c
, 
cou¡
);

50 *
mem£t
(*
de°
, 
vÆ
, 
cou¡
);

53 *
mem£tw
(*
de°
, 
vÆ
, 
cou¡
);

60 
°æí
(c⁄° * 
_°r
);

63 
°r˝y
(* 
_d°
, * 
_§c
);

66 
öt2°r
(
_num
, * 
_°r
);

69 
uöt2°r
(
_num
, * 
_°r
);

76 
öp‹tb
 (
_p‹t
);

77 
öp‹tw
 (
_p‹t
);

80 
ouç‹tb
 (
_p‹t
, 
_d©a
);

81 
ouç‹tw
 (
_p‹t
, 
_d©a
);

	@
1
.
1
/usr/include
36
393
Scheduler.C
Scheduler.H
assert.C
assert.H
blocking_disk.C
blocking_disk.H
console.C
console.H
exceptions.C
exceptions.H
file_system.C
file_system.H
frame_pool.C
frame_pool.H
gdt.C
gdt.H
idt.C
idt.H
interrupts.C
interrupts.H
irq.C
irq.H
kernel.C
machine.C
machine.H
mem_pool.C
mem_pool.H
simple_disk.C
simple_disk.H
simple_timer.C
simple_timer.H
thread.C
thread.H
threads_low.H
utils.C
utils.H
